<!DOCTYPE html>
<html>
<head>
    <title>gForce Inside</title>
    <script src="jquery-1.5.1.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="canvasjs.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            const port = "8888";
            const url = "ws://127.0.0.1:" + port + "/RawData";
            const ws = new WebSocket(url);
            const rawDataSize = 128;
            var rawData = [];

            const canvas = document.getElementById('chart');
            const width = canvas.scrollWidth;
            const height = canvas.scrollHeight;
            console.log("canvas width = %d, height = %d", width, height);
            var ctx = canvas.getContext('2d');
            function drawChart(data) {
                const step = 3;
                ctx.clearRect(0, 0, width, height);
                ctx.beginPath();
                ctx.moveTo(0, height - data[0]);
                for (var x = 1, i = 1; x < width && i < data.length; x += step, i++) {
                    ctx.lineTo(x, height - data[i]);
                }
                ctx.stroke();
            }

            //var chart = new CanvasJS.Chart("chartContainer", {
            //    zoomEnabled: true,
            //    title: {
            //        text: "gForce Raw Data channel[0]"
            //    },
            //    //animationEnabled: true,
            //    //axisX: {
            //    //    labelAngle: 30
            //    //},

            //    //axisY: {
            //    //    includeZero: 0
            //    //},

            //    data: [
            //        {
            //            type: "line",
            //            dataPoints: []
            //        }
            //    ]
            //});


            var cnt = 0;
            ws.onmessage = function (evt) {
                //$("#received").append(evt.data + "<br/>");
                //console.log("typeof = %s, size = %s", typeof evt.data, evt.data.size);
                // data should a blob of 128 bytes
                var blob = evt.data;
                if (blob.size !== rawDataSize) {
                    console.log("[WARNING] The size of the received data is not %d[%d]", rawDataSize, blob.size);
                }

                var fileReader = new FileReader();
                fileReader.onload = function () {
                    var uint8View = new Uint8Array(this.result);
                    //for (var i = 0; i < 8; i++) {
                    //    var singleChannel = [];
                    //    for (var j = 0; j < rawDataSize / 8; j++) {
                    //        singleChannel[j] = uint8View[i + j * 8];
                    //    }
                    //    rawData[i] = singleChannel;
                    //}
                    //for (var j = 0; j < rawDataSize / 8; j++) {
                    //    //console.log("data: %d", uint8View[j * 8]);
                    //    if (chart.options.data[0].dataPoints.length == 800) {
                    //        chart.options.data[0].dataPoints.shift();
                    //    }
                    //    chart.options.data[0].dataPoints.push({ y: uint8View[j * 8] });
                    //}

                    //console.log("count data: %d, %d", ++cnt, uint8View[0]);
                    //if (chart.options.data[0].dataPoints.length == 400) {
                    //    chart.options.data[0].dataPoints.shift();
                    //}
                    //chart.options.data[0].dataPoints.push({ y: uint8View[0] });

                    rawData.push(uint8View[0]);
                    if (rawData.length > 80) {
                        rawData.shift();
                    }
                    drawChart(rawData);
                    //if (cnt % 41 === 0) chart.render();
                };
                fileReader.readAsArrayBuffer(blob);
            };

            ws.onopen = function (evt) {
                $("#url").html(url);
                $("#status").html("Connected to " + url);
                var data = 'sink';
                ws.send(data);
                //$("#sent").append(data + '</br>');
                //data = new Blob([1, 2, 3, 4, 5], { type: 'Application/integer' });
                //ws.send(data);
            };

            ws.onclose = function () {
                $("#status").html("connection closed.");
            };

 
        });
    </script>
    <style type="text/css">
        body {
            font-family: Trebuchet MS;
            font-size: 0.7em;
        }

        #sent {
            font-family: Consolas;
            font-size: 1em;
        }


        #status {
            font-family: Consolas;
            font-size: 1em;
        }

        }
    </style>
</head>
<body>
    <div>
        <h4> Status: <span id="status" /> </h4>
        <h4> Sent: <span id="sent" /> </h4>
        <h4> Received: <span id="received" /> </h4>
        <div id="chartContainer" style="height: 300px; width: 100%;"> </div>
        <canvas id="chart" style="height: 300px; width: 100%;"> </canvas>
    </div>
</body>
</html>
