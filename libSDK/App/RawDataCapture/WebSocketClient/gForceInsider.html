<!DOCTYPE html>
<html lang="en">
<head>
    <title>gForce Insider</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link href="node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="node_modules/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet">
    <script src="node_modules/jquery/dist/jquery.min.js" type="text/javascript"></script>
    <script src="node_modules/bootstrap/dist/js/bootstrap.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            const port = "8888";
            const url = "ws://127.0.0.1:" + port + "/RawData";
            const ws = new WebSocket(url);
            const rawDataSize = 128;
            const channelCount = 8;
            const rawDataSizePerChannel = rawDataSize / channelCount;
            const maxSizePerChannel = rawDataSizePerChannel * 128;
            const rawData = Array.apply(null, Array(channelCount)).map(() => []);

            const ctxArray = new Array(channelCount);
            const canvasArray = Array.apply(null, Array(channelCount)).map(function (e, i) {
                var canvas = document.getElementById('chart' + i);
                var ctx = canvas.getContext('2d');
                ctx.strokeStyle = '#FFFFFF';
                ctxArray[i] = ctx;
                var r = canvas.getBoundingClientRect();
                canvas.width = r.width * 2;
                canvas.height = r.height * 2;
                console.log("canvas pixel buffer width = %d, height = %d", canvas.width, canvas.height);
                return canvas;
            });

            function drawChart() {
                const step = 1;
                ctxArray.forEach(function (ctx, i) {
                    const width = ctx.canvas.width;
                    const height = ctx.canvas.height;
                    var x = step;
                    ctx.strokeStyle = '#00FFFF';
                    ctx.clearRect(0, 0, width, height);
                    ctx.beginPath();
                    console.log(rawData[i][0]);
                    ctx.moveTo(0, height - rawData[i][0] / 256 * height);
                    for (let j = 1; j < rawData[i].length; j++) {
                        if (x > width) {
                            break;
                        }
                        ctx.lineTo(x, height - rawData[i][j] / 256 * height);
                        x += step;
                    }
                    ctx.stroke();

                });
            }

            var cnt = 0;
            ws.onmessage = function (evt) {
                //console.log("typeof = %s, size = %s", typeof evt.data, evt.data.size);

                // data should a blob of 128 bytes
                var blob = evt.data;
                if (blob.size !== rawDataSize) {
                    console.log("[WARNING] The size of the received data is not %d[%d]", rawDataSize, blob.size);
                }

                // Read from the blob and resemble the data
                var fileReader = new FileReader();
                fileReader.onload = function () {
                    var uint8View = new Uint8Array(this.result);
                    for (var i = 0; i < channelCount; i++) {
                        var singleChannel = [];
                        for (var j = 0; j < rawDataSizePerChannel; j++) {
                            rawData[i].push(uint8View[i + j * 8]);
                        }
                        if (rawData[i].length > maxSizePerChannel) {
                            rawData[i].splice(0, rawDataSizePerChannel);
                        }
                    }
                    //console.log("count data: %d, %d", ++cnt, uint8View[0]);
                    window.requestAnimationFrame(drawChart);
                };
                fileReader.readAsArrayBuffer(blob);
            };
            ws.onopen = function (evt) {
                $("#status").removeClass("alert-info").addClass("alert-success").html("Connected to " + url + " succussfully!");

                // Indicate as a data sink.
                var data = 'sink';
                ws.send(data);
            };
            ws.onclose = function () {
                $("#status").removeClass("alert-success").addClass("alert-info").html("Connection to " + url + " closed.");
            };

 
        });
    </script>
    <style type="text/css">
        /*body {
            font-family: Trebuchet MS;
            font-size: 0.7em;
        }

        #sent {
            font-family: Consolas;
            font-size: 1em;
        }*/


        /*#status {
            font-family: Consolas;
            font-size: 1em;
        }*/

        /*.nav {
            width: 100%;
        }*/
        .chart {
            resize: none;
            background: black; 
            color: blue; 
            height: 128px; 
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-xs-12">
                <div class="row">
                    <div class="col-xs-12 col-md-6">
                        <canvas class="chart" id="chart0"> </canvas>
                    </div>
                    <div class="col-xs-12 col-md-6">
                        <canvas class="chart" id="chart1"> </canvas>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12 col-md-6">
                        <canvas class="chart" id="chart2"> </canvas>
                    </div>
                    <div class="col-xs-12 col-md-6">
                        <canvas class="chart" id="chart3"> </canvas>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12 col-md-6">
                        <canvas class="chart" id="chart4"> </canvas>
                    </div>
                    <div class="col-xs-12 col-md-6">
                        <canvas class="chart" id="chart5"> </canvas>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12 col-md-6">
                        <canvas class="chart" id="chart6"> </canvas>
                    </div>
                    <div class="col-xs-12 col-md-6">
                        <canvas class="chart" id="chart7"> </canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <ul class="nav nav-tabs">
        <li role="presentation" class="active">
            <a href="#">Raw Data</a>
        </li>
        <li role="presentation"><a href="#">Settings</a></li>
    </ul>
    <div id="status" class="alert" role="alert"></div>
</body>
</html>
